<!DOCTYPE html>
<html>

<head>
    <title>Cards</title>
    <script src="js/jquery-2.1.1.min.js"></script>
    <script src="js/jspsych.js"></script>
    <script src="plugins/jspsych-resize.js"></script>
    <script src="plugins/jspsych-html-keyboard-response.js"></script>
    <script src="plugins/jspsych-instructions.js"></script>
    <script src="plugins/jspsych-survey-text.js"></script>
    <script src="plugins/jspsych-survey-multi-choice.js"></script>
    <script src="plugins/jspsych-fullscreen.js"></script>
    <script src="plugins/jspsych-html-button-response.js"></script>
    <script src="plugins/jspsych-html-slider-response.js"></script>
    <link href="css/my_exp.css" rel="stylesheet" type="text/css">
    <link href="css/jspsych.css" rel="stylesheet" type="text/css">

</head>

<body>
    <script>

        /*this defines the css properties according to the window_screen_size*/
        var root = document.documentElement;
        var vis_angle_px = 105
        var square_width = 51.4
        root.style.setProperty('--top_middle', window.screen.height / 2 + "px");
        root.style.setProperty('--left_middle', window.screen.width / 2 - (square_width / 2) + "px");
        root.style.setProperty('--top_a', window.screen.height / 2 - vis_angle_px + "px");
        root.style.setProperty('--left_a', window.screen.width / 2 - vis_angle_px + "px");
        root.style.setProperty('--top_b', window.screen.height / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--left_b', window.screen.width / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--top_c', window.screen.height / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--left_c', window.screen.width / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--top_d', window.screen.height / 2 - vis_angle_px + "px");
        root.style.setProperty('--right_d', window.screen.width / 2 - vis_angle_px + "px");
        root.style.setProperty('--top_e', window.screen.height / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--right_e', window.screen.width / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--top_f', window.screen.height / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--right_f', window.screen.width / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--bottom_g', window.screen.height / 2 - vis_angle_px + "px");
        root.style.setProperty('--right_g', window.screen.width / 2 - vis_angle_px + "px");
        root.style.setProperty('--bottom_h', window.screen.height / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--right_h', window.screen.width / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--bottom_i', window.screen.height / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--right_i', window.screen.width / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--bottom_j', window.screen.height / 2 - vis_angle_px + "px");
        root.style.setProperty('--left_j', window.screen.width / 2 - vis_angle_px + "px");
        root.style.setProperty('--bottom_k', window.screen.height / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--left_k', window.screen.width / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--bottom_l', window.screen.height / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--left_l', window.screen.width / 2 - 3 * vis_angle_px + "px");

        root.style.setProperty('--upper1', window.screen.height / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--upper2', window.screen.height / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--upper3', window.screen.height / 2 - vis_angle_px + "px");

        root.style.setProperty('--lower1', window.screen.height / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--lower2', window.screen.height / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--lower3', window.screen.height / 2 - vis_angle_px + "px");

        //---------------------------------------------------------------------------------------------
        root.style.setProperty('--left_card', window.screen.width / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--right_card', window.screen.width / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--top_card', window.screen.height / 2 - 90 + "px");
        root.style.setProperty('--top_reward', window.screen.height / 2 + "px");
        root.style.setProperty('--left_reward', window.screen.width / 2 + "px");
        root.style.setProperty('--top_surprise', window.screen.height / 2 + "px");
        root.style.setProperty('--left_surprise', window.screen.width / 2 + "px");

        /*---------------------------------------------------- 
        Card game starts
        ------------------------------------------------------*/
        /*full screen */
        var enter_fullscreen = {
            type: "fullscreen",
            fullscreen_mode: true
        }
        /*---------------------------------------------------- 
        Define images
        ------------------------------------------------------*/

        var practice_deck_images = ['images/old/17.jpg', 'images/old/18.jpg', 'images/old/19.jpg', 'images/old/20.jpg']
        var test_deck_images = ['images/old/1.jpg', 'images/old/2.jpg', 'images/old/3.jpg', 'images/old/4.jpg', 'images/old/5.jpg', 'images/old/6.jpg', 'images/old/7.jpg', 'images/old/8.jpg'
            , 'images/old/9.jpg', 'images/old/10.jpg', 'images/old/11.jpg', 'images/old/12.jpg', 'images/old/13.jpg', 'images/old/14.jpg', 'images/old/15.jpg', 'images/old/16.jpg' ]
        var reward_images = ['images/zero_coins.png', 'images/won1-no-back1.png']
        var fixation = '<div class="fixation">+</div>'
        var surprise= 'images/surprise.jpeg'
        var catch_trials_images = jsPsych.randomization.shuffle(['images/catch_trial/1.jpg', 'images/catch_trial/2.jpg', 'images/catch_trial/3.jpg', 'images/catch_trial/4.jpg', 'images/catch_trial/5.jpg', 'images/catch_trial/6.jpg', 'images/catch_trial/7.jpg', 'images/catch_trial/8.jpg',
                                    'images/catch_trial/9.jpg', 'images/catch_trial/10.jpg', 'images/catch_trial/11.jpg', 'images/catch_trial/12.jpg', 'images/catch_trial/13.jpg', 'images/catch_trial/14.jpg', 'images/catch_trial/15.jpg', 'images/catch_trial/16.jpg',
                                    'images/catch_trial/17.jpg', 'images/catch_trial/18.jpg', 'images/catch_trial/19.jpg', 'images/catch_trial/20.jpg', 'images/catch_trial/21.jpg', 'images/catch_trial/22.jpg', 'images/catch_trial/23.jpg', 'images/catch_trial/24.jpg',
                                    'images/catch_trial/25.jpg', 'images/catch_trial/26.jpg', 'images/catch_trial/27.jpg', 'images/catch_trial/28.jpg', 'images/catch_trial/29.jpg', 'images/catch_trial/30.jpg', 'images/catch_trial/31.jpg', 'images/catch_trial/32.jpg',
                                    'images/catch_trial/33.jpg', 'images/catch_trial/34.jpg', 'images/catch_trial/35.jpg', 'images/catch_trial/36.jpg', 'images/catch_trial/37.jpg', 'images/catch_trial/38.jpg', 'images/catch_trial/39.jpg', 'images/catch_trial/40.jpg',
                                    'images/catch_trial/41.jpg', 'images/catch_trial/42.jpg', 'images/catch_trial/43.jpg', 'images/catch_trial/44.jpg', 'images/catch_trial/45.jpg', 'images/catch_trial/46.jpg', 'images/catch_trial/47.jpg', 'images/catch_trial/48.jpg',
                                    'images/catch_trial/49.jpg', 'images/catch_trial/50.jpg', 'images/catch_trial/51.jpg', 'images/catch_trial/52.jpg', 'images/catch_trial/53.jpg', 'images/catch_trial/54.jpg', 'images/catch_trial/55.jpg', 'images/catch_trial/56.jpg',
                                    'images/catch_trial/57.jpg', 'images/catch_trial/58.jpg', 'images/catch_trial/59.jpg', 'images/catch_trial/60.jpg', 'images/catch_trial/61.jpg', 'images/catch_trial/62.jpg', 'images/catch_trial/63.jpg', 'images/catch_trial/64.jpg'])
        var practice_catch_trials_images= jsPsych.randomization.shuffle(['images/practice_catch_trials/1.png','images/practice_catch_trials/2.png','images/practice_catch_trials/3.png','images/practice_catch_trials/4.png'])


        /*----------------------------------------------------
        Define game-related settings
        ------------------------------------------------------*/
        var block_type=Number(jsPsych.randomization.sampleWithoutReplacement([0,1,2,3], 1));
        var trial_type=0;
        //0-A B, 1- C D, 2-catch trial
        var trial_order=jsPsych.randomization.shuffle([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2])
        var catch_trials_number = 0;
        var sum_reward_catch_trials=0;
        var sum_reward_test_trials=0;
        var practice_order=jsPsych.randomization.shuffle([0,0,1,1,2,2])
        var practice_number=-1;
        var practice_type;
        /*---------------------------------------------------- 
        Start instructions
        ------------------------------------------------------*/
        var instructions_cards = {
            on_start: function () {
                if (document.querySelector('#cursor-toggle') != null) {
                    document.querySelector('#cursor-toggle').remove()
                }
            },
            type: "instructions",
            pages: ["<p><b><u>Welcome to the card game</u></b></p>"
                + "<p style='text-align:left'>Your winnings in this game will earn you additional payment bonus for the study."
                + " If no extra money will be earned in the card game, you will still get £2.5 for completing this session of the study."
                + " However, <b>you can gain up to an extra £0.9 based on winnings in the game.</b></p>",
                "<p style='text-align:left'> We will now provide instructions regarding the card game. Please read them carefully. <br>"
                + "Feel free to go back and forth between the screens.</p> "
                + "<p style='text-align:left'>At the end of the instructions, <b>we will ask you to complete a short quiz about them</b>, to make sure everything is well understood.</p>",
                "<p style='text-align:left'> Below is an example of a card-deck of four cards, very much like the cards in the game to follow. </p>" +
                "<img class='exampleDeck' src='images/old/1.jpg' >"+"<img class='exampleDeck' src='images/old/3.jpg' >"+
                "<img class='exampleDeck' src='images/old/8.jpg' >"+"<img class='exampleDeck' src='images/old/9.jpg' >",
                "<p> On each step, only two cards from the 4-card deck will be offered (as shown in the example below).<br>You will be able to select the <b>left card by pressing 'S'</b> and the <b>right card by pressing 'K'</b> on your keyboard."
                + " <br><br><u>Please do your best to respond as fast and as accurate as you can.</u><br><br>"
                + "<img class='exampleDeck' src='images/old/1.jpg' >"+ "<img class='exampleDeck' src='images/old/9.jpg' >",
                "<p style='text-align:left'>After selecting the card, you will see an outcome in the middle of the screen, as shown below.<br><br>"
                + "<b>Winning very much depends on the card you chose - some cards are better than others in their deck.</b><br>"
                + "Your task is to find out which card is the best in each deck at any time and choose it.<br><br> <b> Please note that the winning chances of the cards are independent</b>.<br> Learning about one card does not tell you anything about the other cards."
                + "<br> Also, a card's winning chances <b>do not change</b> throughout the game.</p>"
                + "<br> <img class='exampleDeck' src='images/old/1.jpg' >"+"<img class=exampleReward src='images/won1-no-back2.png'>",
                "<p style='text-align:left'><u>Two important things to remember:</u><br>"
                 + " 1.<b> Only the cards are related to your chances of winning - </b> the location of the card and the response key you used to select it do not influence the chances of winning a coin.<br><br>"
                 + " 2. <b>The chance that each card will give you money has nothing to do with the other cards - </b> you can't learn about one card from the money rewards you got for the other.</p>"],
                show_clickable_nav: true
        };
        var instructions_combined = {
            on_start: function () {
                if (document.querySelector('#cursor-toggle') != null) {
                    document.querySelector('#cursor-toggle').remove()
                }
            },
            type: "instructions",
            pages: [" <p style='text-align:left'>In the experiment you will play the card game that has been explained above."
                +"<br>In addition, once every few steps, you will be presented with two brand new shapes. You will need to select one the same way you select cards. <b>It is an opportunity for you to earn more money!</b>"
                +"<br>Below is an example of such two shapes. Notice - each shape will appear exactly once in the game!</p>"
                +"<br> <img class='example' src='images/group-shapes.png'>",
                " <p style='text-align:left'> <br>It means you have another task, and that is to earn as much money as you can in shapes steps.<br>"
                +" Note that you won't be able to tell what the outcome of your selection was right after selecting a shape. Instead, <b>at the end of the block, you will be informed of the total amount you've earned from shapes steps. </b> "
                +"<br>As in the card game, pressing <b>'S'</b> means you think the left shape is better, and pressing <b>'K'</b> means you think the right shape is better.</p>"],
                show_clickable_nav: true
        }
        var start_instructions_test = {
            on_start: function () {
                if (document.querySelector('#cursor-toggle') != null)
                    document.querySelector('#cursor-toggle').remove()
            },
            type: 'html-keyboard-response',
            stimulus: "<p> <br><br> You will now move on to a quick quiz to make sure you understood the instructions. If you make a mistake, you will need to go through the instructions again. <br><br> <b> Press any key to continue</b></p>"
        }
        var Q1_2_options = ["2", "4", "6"];
        var Q3_options = ["Click on it.", "Press the LEFT or RIGHT arrow keys.", "Press the 'S' or 'K' key with your LEFT or RIGHT hand."];
        var Q4_5_options = ["True", "False"];
        var Q6_options = ["True", "False"];
        var Q7_options = ["True - the response keys are related to the winning chances.", "False - you won't win more or less using RIGHT or LEFT response keys. Only the cards are related to your chance of winning."];
        var Q8_options = ["After choosing the shape.", "At the end of the block.", "At the end of the game.", "Never."];
        var Q9_options = ["True", "False"];



        var instructions_test = {
            type: 'survey-multi-choice',
            questions: [
                { prompt: "What is the size of a card deck?", name: 'deck_size', correct: '4', options: Q1_2_options, required: true },
                { prompt: "How many cards are presented on each step?", name: 'cards_step', correct: '2', options: Q1_2_options, required: true },
                { prompt: "How do you choose a card?", name: 'choose_card', correct: "Press the 'S' or 'K' key with your LEFT or RIGHT hand.", options: Q3_options, required: true },
                { prompt: "Some cards are better than others.", name: 'better_cards', correct: 'True', options: Q4_5_options, required: true },
                { prompt: "How 'good' or 'bad' a card is will change along the game.", name: 'value_change', correct: 'False', options: Q4_5_options, required: true },
                { prompt: "If one card leads you to a large sum of money, it means the other card will probably lead you to a small sum of money.", name: 'value_independence', correct: 'False', options: Q6_options, required: true },
                { prompt: "If you use the RIGHT and not the LEFT response keys, you might win more", name: 'location_value', correct: "False - you won't win more or less using RIGHT or LEFT response keys. Only the cards are related to your chance of winning.", options: Q7_options, required: true },
                { prompt: "When do you know how many coins you got from steps in which you are choosing a shape?", name: 'reward_announce', correct: "At the end of the block.", options: Q8_options, required: true },
                { prompt: "The same shape can be presented multiple times throughout the game.", name: 'shapes_repeated', correct: 'False', options: Q9_options, required: true },

            ],
        };

        var if_trial = {
            type: 'html-button-response',
            stimulus: "<p>Sorry. You made a mistake.<br>"
                + "Let's go back to the instructions. "
                + "Please read them carefully before submitting your answers. <br>"
                + "Thank you!",
            choices: ['Back to instructions']
        }
        var to_repeat;
        var check_answers = {
            timeline: [if_trial],
            conditional_function: function () {
                // get the data from the previous trial,
                // and check which key was pressed
                to_repeat = false;
                var responses_to_test = JSON.parse(jsPsych.data.get().filter({ trial_type: 'survey-multi-choice' }).last(1).select('responses').values[0])
                for (i = 0; i < instructions_test.questions.length; i++) {
                    current_name = instructions_test.questions[i].name;
                    current_correct = instructions_test.questions[i].correct
                    if (current_correct != responses_to_test[current_name]) {
                        to_repeat = true;
                        return to_repeat
                    }
                    else {
                        to_repeat = false;

                    }
                }
                return to_repeat
            }
        }
        /*---------------------------------------------------- 
        Functions for card game
        ------------------------------------------------------*/

        function draw_show_cards(deck, catch_deck, practice) {
            if (practice==1){ //practice only cards
                drawn= jsPsych.randomization.sampleWithoutReplacement([0,2],1);
                if (drawn==0){
                    arr= jsPsych.randomization.shuffle([deck[0], deck[1]]);
                }
                else{
                    arr= jsPsych.randomization.shuffle([deck[2], deck[3]]);
                }
                left_card=arr[0];
                right_card=arr[1];
                left_with_tag = "<img class='card_left' src='" + left_card + "'>"
                right_with_tag = "<img class='card_right' src='" + right_card + "'>"
                return left_with_tag + right_with_tag + fixation;
            }
            if (practice==2){ //full practice
                trial_type=practice_order[practice_number];
            }
            if (trial_type==0){ //A B
                arr= jsPsych.randomization.shuffle([deck[0],deck[1]])
                left_card=arr[0];
                right_card=arr[1];
                left_with_tag = "<img class='card_left' src='" + left_card + "'>"
                right_with_tag = "<img class='card_right' src='" + right_card + "'>"
            }
            else if (trial_type==1){// C D
                arr= jsPsych.randomization.shuffle([deck[2],deck[3]])
                left_card=arr[0];
                right_card=arr[1];
                left_with_tag = "<img class='card_left' src='" + left_card + "'>"
                right_with_tag = "<img class='card_right' src='" + right_card + "'>"
            }
            else{ // catch trial
                left_card= catch_deck[catch_trials_number]
                right_card= catch_deck[catch_trials_number+1]
                catch_trials_number+=2;
                if(block>=2){
                    left_with_tag = "<img class='card_left' src='" + left_card + "' style='transform: rotate(180deg);'>"
                    right_with_tag = "<img class='card_right' src='" + right_card + "' style='transform: rotate(180deg);'>"
                }
                else{
                    left_with_tag = "<img class='card_left' src='" + left_card + "'>"
                    right_with_tag = "<img class='card_right' src='" + right_card + "'>"
                }
                surprise_to_show = "<img class=surprise src='" + surprise + "'>"
                return left_with_tag + surprise_to_show + right_with_tag;

            }

            return left_with_tag + right_with_tag + fixation;
        }

        function show_choice() {
            last_choice = jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(jsPsych.data.getLastTrialData().values()[0].key_press)
            if (last_choice == 's') { 
                selected = 0
                if(trial_type==2 && block>=2){
                    card_to_show = "<img class='card_left' src='" + left_card + "' style='transform: rotate(180deg);'>"  
                }
                else{
                    card_to_show = "<img class='card_left' src='" + left_card + "'>"
                }
            }
            else if (last_choice == 'k') {
                selected = 1
                if(trial_type==2 && block>=2){
                    card_to_show = "<img class='card_right' src='" + right_card + "' style='transform: rotate(180deg);'>"
                }
                else{
                    card_to_show = "<img class='card_right' src='" + right_card + "'>"
                }
            }
            else {
                selected = null
                reward = 0
                return '<div style="font-size:40px;">Please respond faster!</div>'
            }
            if(trial_type==2){
                surprise_to_show = "<img class=surprise src='" + surprise + "'>"
                return card_to_show + surprise_to_show
            }
            return card_to_show + fixation
        }

        function show_reward (){
            key_selected = jsPsych.data.getLastTrialData().values()[0].key_selected
            if (key_selected == 0) {    
                if(trial_type==2 && block>=2){
                    card_to_show = "<img class='card_left' src='" + left_card + "' style='transform: rotate(180deg);'>"
                }
                else{
                    card_to_show = "<img class='card_left' src='" + left_card + "'>"
                }
            }
            else if (key_selected == 1) {
                if(trial_type==2 && block>=2){
                    card_to_show = "<img class='card_right' src='" + right_card + "' style='transform: rotate(180deg);'>"
                }
                else{
                    card_to_show = "<img class='card_right' src='" + right_card + "'>"
                }
            }
            else {
                return '<div style="font-size:40px;">Please respond faster!</div>'
            }
            card_selected = jsPsych.data.getLastTrialData().values()[0].card_selected
            if (trial_type == 2){
                prob_reward = 0.5;
            }
            else{
                prob_reward = FB_array[card_selected+block_type*4];
            }
            prob_unreward = 1 - prob_reward;
            reward = jsPsych.randomization.sampleWithReplacement([0, 1], 1, [prob_unreward, prob_reward])[0];
            reward_to_show = "<img class=reward src='" + reward_images[reward] + "'>"
            if (trial_type == 2){
                sum_reward_catch_trials+=reward;
                surprise_to_show = "<img class=surprise src='" + surprise + "'>"
                return card_to_show + surprise_to_show
            }
            else{
                sum_reward_test_trials+=reward;
                return card_to_show + reward_to_show
            }
        }

        function images_for_block_start() {
            images = test_deck_images.slice(block_type * 4, block_type * 4 + 4)
            return images
        }

        /*This function downloads the data */
        var subN = localStorage.subN
        var IDsub = Date.now();
        function download_csv(csv) {
            var hiddenElement = document.createElement('a');
            file_name = "WM_visual_array_" + subN + "_" + IDsub.toString() + ".csv"
            hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            hiddenElement.target = '_blank';
            hiddenElement.download = file_name;
            hiddenElement.click();
        }
        /*---------------------------------------------------- 
        Variables for card game
        ------------------------------------------------------*/
        var FB_array = [0.25,0.35,0.25,0.35,0.65,0.75,0.65,0.75,0.1,0.5,0.1,0.5,0.5,0.9,0.5,0.9];
        var current_cards_practice_trial = 0;
        var current_cards_exp_trial = 0;
        var block = 0;
        var blocks = 4;
        var left_card;
        var right_card;
        var selected;
        var reward;

        /*---------------------------------------------------- 
        Start practice
        ------------------------------------------------------*/
        var timeline = [];
        timeline.push(enter_fullscreen)
        var start_practice_only_cards = {
            type: 'html-keyboard-response',
            stimulus: '<div>We will now start a few practice trials which will contain only the cards part, without the shapes. <br> Please be ready with your fingers on <b>"S"</b> and <b>"K"</b>. <br><br> <b> Press any key to begin</b></div>',
            post_trial_gap: 1000,
            on_finish: function () { 
                practice_type=1;
                document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>') 
            },
        }
        var start_practice_cards = {
            type: 'html-keyboard-response',
            stimulus: '<div>We will now start a few practice trials with both the cards and the shapes. <br> Please be ready with your fingers on <b>"S"</b> and <b>"K"</b>. <br><br> <b> Press any key to begin</b></div>',
            post_trial_gap: 1000,
            on_finish: function () { //trial_by_trial condition for practice
                practice_type=2;
                document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>')
            }
        }

        var fixation_cards = {
            type: 'html-keyboard-response',
            stimulus: fixation,
            choices: jsPsych.NO_KEYS,
            trial_duration: 900
        }

        var practice_cards1 = {
            type: "html-keyboard-response",
            stimulus: function () {
                if(practice_type==2){
                    practice_number+=1;
                }
                return draw_show_cards(practice_deck_images, practice_catch_trials_images, practice_type)
            },
            choices: ['s', 'k'],
            trial_duration: 6000,
            data: { phase: 'practice', trial_name: 'cards1', trial_num: function () { return current_cards_practice_trial } },

        }

        var practice_choice1 = {
            type: "html-keyboard-response",
            stimulus: show_choice,
            choices: jsPsych.NO_KEYS,
            trial_duration: 500,
            data: { phase: 'practice', trial_name: 'choice1', trial_num: function () { return current_cards_practice_trial } },
            on_finish: function (data) {
                data.key_selected = selected
                if (selected == 0) {
                    data.card_selected = practice_deck_images.indexOf(left_card)
                }
                else if (selected == 1) {
                    data.card_selected = practice_deck_images.indexOf(right_card)
                }
            }
        }

        var practice_reward1 = {
            type: "html-keyboard-response",
            stimulus: function () {
                return show_reward()
            },
            choices: jsPsych.NO_KEYS,
            trial_duration: 750,
            data: { phase: 'practice', trial_name: 'reward1', trial_num: function () { return current_cards_practice_trial } }
            , on_finish: function (data) {
                data.reward = reward;
            }
        }

        /*---------------------------------------------------- 
        Start exp part of card game
        ------------------------------------------------------*/

        var start_exp = {
            type: 'html-keyboard-response',
            stimulus: '<div> Good job! Practice completed. <br> <br> We will now move on to the real game. Do your best to figure out which cards are better. Good luck!<br><br> <b>Press any key to continue.</b></div>',
            post_trial_gap: 1000,
        }

        var start_block = {
            type: 'html-keyboard-response',
            stimulus: function () {
                block_type=(block_type+1)%4;
                if(block==0){
                    catch_trials_number=0;
                }
                return '<p><b><u>Test block ' + (block + 1) + ' out of ' + (blocks) + '</u></b></p>' + '<p style="text-align: left"> You will now start a test block. Below are the four cards that can appear in this round.</p>'
                    + '<p style="text-align: left">Use the LEFT or RIGHT response keys ("S" or "K", in correspondence) to make your selection. <br> Please do your best to win as many coins as possible!<br> </p>'
                    + '<p style="text-align: left">Remember that: <br> 1) Only the cards (not the response key that was used to select them) predict an outcome <br> 2) The chance that each card will give you money has nothing to do with the other cards </p>'
                    + '<p><b>Press SPACE to start</b></p>'
                    + '<img class=start src="' + images_for_block_start()[0] + '">  ' + '<img class=start src="' + images_for_block_start()[1] + '">    ' + '<img class=start src="' + images_for_block_start()[2]
                    + '">    ' + '<img class=start src="' + images_for_block_start()[3] + '">  '
            },
            choices: [32]
            , post_trial_gap: 1000,
            on_finish: function () { document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>') },
        }

        var exp_cards1 = {
            type: "html-keyboard-response",
            stimulus: function () {
                trial_type=trial_order[current_cards_exp_trial]
                return draw_show_cards(images_for_block_start(), catch_trials_images, 0)
            },
            choices: ['s', 'k'],
            trial_duration: 6000,
            data: { phase: 'exp', trial_name: 'cards1', trial_num: function () { return current_cards_exp_trial },
                    type_of_trial: function () { return (trial_type) }, block_type: function () { return block_type}  
                },
        }

        var exp_choice1 = {
            type: "html-keyboard-response",
            stimulus: show_choice,
            choices: jsPsych.NO_KEYS,
            trial_duration: 500,
            data: { phase: 'exp', trial_name: 'choice1', trial_num: function () { return current_cards_exp_trial },
                    type_of_trial: function () { return trial_type } },
            on_finish: function (data) {
                data.key_selected = selected
                if (selected == 0) {
                    data.card_selected = images_for_block_start().indexOf(left_card)
                }
                else if (selected == 1) {
                    data.card_selected = images_for_block_start().indexOf(right_card)
                }
            }
        }
        var exp_reward1 = {
            type: "html-keyboard-response",
            stimulus: function () {
                return show_reward()
            },
            choices: jsPsych.NO_KEYS,
            trial_duration: 750,
            data: {
                phase: 'exp', trial_name: 'reward1', trial_num: function () { return current_cards_exp_trial },
                type_of_trial: function () { return trial_type }, block: function () { return block } },

            on_finish: function (data) {
                current_cards_exp_trial+=1;
                data.reward = reward;
                data.key_selected = selected
                if (selected == 0) {
                    data.card_selected = images_for_block_start().indexOf(left_card)
                }
                else if (selected == 1) {
                    data.card_selected = images_for_block_start().indexOf(right_card)
                }
            }
        }

        var finish_block = {
            type: 'html-keyboard-response',
            stimulus: function () {
    
                finish_block_string = '<p>Good job!</p>' + '<p style="text-align: left"><br> Test block ' + (block + 1) + ' out of ' + (blocks) + ' is over.'
                finish_block_string += ' You earned ' + sum_reward_test_trials + ' coins on cards trials and ' + sum_reward_catch_trials + ' coins on shapes trials.<br>'
                if (block != 3) {
                    finish_block_string += 'You can stretch a little and take a short break while sitting in front of the screen, if needed.</p><p> <br><br><br><b>Press SPACE to continue</b>  </p>'
                }
                else {
                    finish_block_string += 'We will now continue to answer some questions.</p><p> <br><br><br><b>Press SPACE to continue</b>  </p>'
                }
                return finish_block_string
            },
            post_trial_gap: 1000,
            choices: [32],
            on_finish: function () {
                if (block == 1) {
                    catch_trials_number=0;
                    catch_trials_images=jsPsych.randomization.shuffle(catch_trials_images);
                }
                block += 1;
                current_cards_exp_trial = 0;
                trial_order=jsPsych.randomization.shuffle(trial_order);
                sum_reward_catch_trials=0;
                sum_reward_test_trials=0;
            }
        }

        /*---------------------------------------------------- 
        Define timeline for card part
        ------------------------------------------------------*/
        var demo_procedure_only_cards = {
            timeline: [fixation_cards, practice_cards1, practice_choice1, practice_reward1],
            repetitions: 1  //every trial takes 500+200+2*(900+1500+500+750)+1500+500 =10 sec per trial, 6 trials = 60 sec
        }

        var demo_procedure_cards = {
            timeline: [fixation_cards, practice_cards1, practice_choice1, practice_reward1],
            repetitions: 1 //every trial takes 500+200+2*(900+1500+500+750)+1500+500 =10 sec per trial, 6 trials = 60 sec
        }

        var instructions_loop = {
            //timeline: [instructions_cards, start_practice_only_cards, demo_procedure_only_cards, instructions_combined, start_practice_cards, demo_procedure_cards,start_instructions_test, instructions_test, check_answers],
            timeline: [instructions_combined, start_practice_cards, demo_procedure_cards,start_instructions_test, instructions_test, check_answers],
            loop_function: function () {
                if (to_repeat == true) {
                    return true;
                } else {
                    return false;
                }
            }
        }
        var test_procedure_cards = {
            timeline: [fixation_cards, exp_cards1, exp_choice1, exp_reward1],
            repetitions: 4 // 10sec per trial - 50 trials per block.
        }
        var test_blocks = {
            timeline: [start_block, test_procedure_cards, finish_block],
            repetitions: 2
        };

        var full_procedure_cards = {
            //timeline: [instructions_loop, start_exp, test_blocks]
            timeline: [start_exp, test_blocks]


        } //instructions+test takes 180sec 
        timeline.push(full_procedure_cards)

        /*---------------------------------------------------- 
              Define init for the whole experiment
              ------------------------------------------------------*/
        jsPsych.init({
            timeline: timeline,
            preload_images: practice_deck_images, test_deck_images, reward_images,fixation, surprise,catch_trials_images, practice_catch_trials_images,
            show_preload_progress_bar: true,
            on_finish: function () {
                // This all part is not used in this experiment (showing participants their bonus and capacity)
                /*calculate accuracy in squares part of cards game */
                var correct_test_squares = jsPsych.data.get().filter({ phase: 'exp', trial_name: 'test_cards' }).select('is_correct').sum()
                var total_test_squares = jsPsych.data.get().filter({ phase: 'exp', trial_name: 'test_cards' }).select('is_correct').count()
                var test_squares_cards_accuracy = correct_test_squares / total_test_squares;
                var test_squares_cards_accuracy = test_squares_cards_accuracy.toFixed(2)
                localStorage.accuracy = test_squares_cards_accuracy; //accuracy to show
                /*calculate bonus */
                var number_of_reward1 = jsPsych.data.get().filter({ phase: 'exp', trial_name: 'reward1' }).select('reward').sum()
                var number_of_reward2 = jsPsych.data.get().filter({ phase: 'exp', trial_name: 'reward2' }).select('reward').sum()
                var bonus = 0.003 * (number_of_reward1 + number_of_reward2)
                var bonus_string = bonus.toFixed(2)
                localStorage.bonus = bonus_string; //bonus to show
                /*get data */
                processed_data = jsPsych.data.get().json()
                download_csv(jsPsych.data.get().csv())
                $.ajax({
                    type: 'POST',
                    url: '/save',
                    data: { 'data': processed_data },
                    success: function () {
                        console.log('success');
                        document.location = '/next'
                    },
                    // Endpoint not running, local save
                    error: function (err) {
                        console.log(err)
                    }
                });
            }
        });
        /*----------------------------------------------------
        After experiment
        ------------------------------------------------------*/
        /* we don't use it here. we have after_exp
        var timeline = [];
        var accuracy = localStorage.accuracy;
        var bonus = localStorage.bonus;
        
        var conclusion = {
            type: 'html-keyboard-response',
            stimulus: function () {
                var feedback_string = '<div style="font-size:20px;">This task is over. Thank you for your participation and see you tomorrow.<br>';
                return feedback_string
            }
        }
        timeline.push(conclusion)
        */
    </script>

</body>

</html>
